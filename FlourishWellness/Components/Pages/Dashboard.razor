@using FlourishWellness.Models
@using FlourishWellness.Services
@using Microsoft.AspNetCore.Components.Web

@page "/dashboard"
@inject SurveyService SurveyService
@inject AuthService AuthService
@inject AuthStateService AuthStateService
@inject NavigationManager NavigationManager
@inject LogService LogService
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Dashboard - FlourishWellness</PageTitle>

<h3>Admin Dashboard</h3>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
    <!-- Total Users Card -->
    <div style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 5px solid #007bff;">
        <h4 style="margin-top: 0; color: #6c757d; font-size: 14px; text-transform: uppercase;">Total Users</h4>
        <p style="font-size: 32px; font-weight: bold; margin: 10px 0; color: #333;">@userCount</p>
        <div style="font-size: 12px; color: #6c757d;">
            Registered accounts
        </div>
    </div>

    <!-- Total Responses Card -->
    <div style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 5px solid #28a745;">
        <h4 style="margin-top: 0; color: #6c757d; font-size: 14px; text-transform: uppercase;">Total Responses</h4>
        <p style="font-size: 32px; font-weight: bold, margin: 10px 0; color: #333;">@responseCount</p>
        <div style="font-size: 12px; color: #6c757d;">
            Individual answers submitted
        </div>
    </div>

    <!-- Total Questions Card -->
    <div style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 5px solid #17a2b8;">
        <h4 style="margin-top: 0; color: #6c757d; font-size: 14px; text-transform: uppercase;">Active Questions</h4>
        <p style="font-size: 32px; font-weight: bold; margin: 10px 0; color: #333;">@questionCount</p>
        <div style="font-size: 12px; color: #6c757d;">
            Across all sections
        </div>
    </div>
</div>

<div style="margin-top: 40px;">
    <h4>Quick Actions</h4>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <a href="/admin" style="text-decoration: none; background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #ddd; width: 200px; text-align: center; color: #333; transition: background-color 0.2s;">
            <div style="font-size: 24px; margin-bottom: 10px;">&#9881;</div>
            <strong>Manage System</strong>
        </a>
        <a href="/results" style="text-decoration: none; background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #ddd; width: 200px; text-align: center; color: #333; transition: background-color 0.2s;">
            <div style="font-size: 24px; margin-bottom: 10px;">&#128202;</div>
            <strong>View Reports</strong>
        </a>
    </div>
</div>

@code {
    private int userCount = 0;
    private int responseCount = 0;
    private int questionCount = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await AuthStateService.InitializeAsync();
            await AuthStateService.RefreshCurrentUserAsync();

            if (!AuthStateService.IsAdmin)
            {
                await LogService.LogAsync("Unauthorized dashboard access attempt", AuthStateService.CurrentUser?.Email ?? "Unknown");
                NavigationManager.NavigateTo("/");
                return;
            }

            await LoadStats();
        }
        catch (Exception ex)
        {
            await LogService.LogAsync($"Error in Dashboard OnInitializedAsync: {ex.Message}", "System");
            Console.WriteLine($"Dashboard page error: {ex}");
        }
    }

    private async Task LoadStats()
    {
        try
        {
            var users = await AuthService.GetAllUsersAsync();
            userCount = users?.Count ?? 0;

            var sections = await SurveyService.GetSectionsWithResponsesAsync();
            
            // Calculate totals
            responseCount = 0;
            questionCount = 0;
            
            if (sections != null)
            {
                CountStats(sections);
            }
        }
        catch (Exception ex)
        {
            await LogService.LogAsync($"Error loading stats: {ex.Message}", "System");
        }
    }

    private void CountStats(List<Section> sections)
    {
        foreach (var sec in sections)
        {
            foreach (var q in sec.Questions)
            {
                questionCount++;
                responseCount += q.Responses.Count;
            }
            
            if (sec.Subsections.Any())
            {
                CountStats(sec.Subsections);
            }
        }
    }
}
